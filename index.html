<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>KTransport360 Driver App</title>
    <style>
        /* General Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* Removes tap highlight on mobile */
        }

        /* Body and Overall Layout */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* Purple-blue gradient */
            min-height: 100vh; /* Changed for consistent height */
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scroll */
            display: flex; /* Use flexbox for body to ensure mobile-container fills height */
            flex-direction: column; /* Stack children vertically */
        }

        .mobile-container {
            max-width: 100%;
            margin: 0;
            background: white;
            min-height: 100vh; /* Changed for consistent height */
            position: relative;
            display: flex; /* Make it a flex container */
            flex-direction: column; /* Arrange header, main, footer in a column */
            flex-grow: 1; /* Allow it to grow and fill body height */
            overflow: hidden; /* Hide overflow of the container itself, main-content will scroll */
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db); /* Dark blue to light blue gradient */
            color: white;
            padding: 20px 15px;
            text-align: center;
            position: sticky; /* Sticky header */
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            flex-shrink: 0; /* Prevent header from shrinking */
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Status Bar */
        .status-bar {
            background: #27ae60; /* Emerald green */
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1em;
            flex-shrink: 0; /* Prevent status bar from shrinking */
        }

        /* Main Content Area */
        .main-content {
            padding: 20px 15px;
            padding-bottom: 120px; /* Space for bottom nav */
            flex-grow: 1; /* Allows content to expand and take available space */
            overflow-y: auto; /* Adds scrollbar when content overflows vertically */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        /* Buttons */
        .schedule-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two columns for today/tomorrow buttons */
            gap: 15px;
            margin-bottom: 20px;
        }

        .big-button {
            width: 100%;
            padding: 25px 15px;
            margin: 10px 0;
            border: none;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            min-height: 80px; /* Ensure consistent height */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.3;
        }

        .big-button:active {
            transform: scale(0.95); /* Shrink effect on tap */
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .btn-today {
            background: linear-gradient(135deg, #27ae60, #229954); /* Green gradient */
            color: white;
        }

        .btn-tomorrow {
            background: linear-gradient(135deg, #3498db, #2980b9); /* Blue gradient */
            color: white;
        }

        .btn-add {
            background: linear-gradient(135deg, #9b59b6, #8e44ad); /* Purple gradient */
            color: white;
        }

        .btn-export {
            background: linear-gradient(135deg, #34495e, #2c3e50); /* Dark grey gradient */
            color: white;
        }

        .btn-future { /* New style for Future Rides button */
            background: linear-gradient(135deg, #e74c3c, #c0392b); /* Reddish gradient */
            color: white;
        }

        /* Customer Ride Cards */
        .customer-card {
            background: white;
            border: 3px solid #e9ecef; /* Light grey border */
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .customer-card.active-ride {
            border-color: #27ae60; /* Green border for active rides */
            background: linear-gradient(135deg, #f8fff8, #f0fff0); /* Very light green background */
            animation: glow 3s infinite; /* Pulsing glow animation */
        }

        .customer-card.completed {
            border-color: #95a5a6; /* Grey border for completed rides */
            background: #f5f5f5; /* Light grey background */
            opacity: 0.8;
        }

        @keyframes glow {
            0%, 100% { 
                box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3); /* Green shadow */
                transform: translateY(0);
            }
            50% { 
                box-shadow: 0 8px 25px rgba(39, 174, 96, 0.5); /* Stronger green shadow */
                transform: translateY(-2px); /* Slight lift */
            }
        }

        .customer-info {
            margin-bottom: 20px;
        }

        .customer-name {
            font-size: 1.6em;
            font-weight: bold;
            color: #2c3e50; /* Dark blue-grey */
            margin-bottom: 10px;
        }

        .customer-details {
            font-size: 1.1em;
            line-height: 1.6;
            color: #555;
        }

        .route-info {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef); /* Very light grey gradient */
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 5px solid #3498db; /* Blue left border */
        }

        .customer-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .customer-buttons button {
            flex: 1; /* Distribute space evenly */
            padding: 20px;
            border: none;
            border-radius: 12px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        /* Specific button styles for pickup/dropoff, adjusted to match new layout */
        .btn-pickup {
            background: linear-gradient(135deg, #27ae60, #229954); /* Green gradient */
            color: white;
            font-size: 1.4em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .btn-dropoff {
            background: linear-gradient(135deg, #f39c12, #e67e22); /* Orange gradient */
            color: white;
            font-size: 1.4em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }


        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 12px 20px;
            border-radius: 25px; /* Pill shape */
            font-size: 1em;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 15px;
        }

        .status-scheduled {
            background: linear-gradient(135deg, #3498db, #2980b9); /* Blue */
            color: white;
        }

        .status-picked-up { /* Corrected class name */
            background: linear-gradient(135deg, #27ae60, #229954); /* Green */
            color: white;
        }

        .status-completed {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d); /* Grey */
            color: white;
        }

        /* Alerts */
        .alert {
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
            font-size: 1.1em;
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb); /* Light green */
            color: #155724; /* Dark green text */
            border: 2px solid #c3e6cb;
        }

        .alert-info {
            background: linear-gradient(135deg, #cce7ff, #99d6ff); /* Light blue */
            color: #004085; /* Dark blue text */
            border: 2px solid #99d6ff;
        }

        /* Notifications (Toast-like) */
        .notification {
            position: fixed;
            bottom: 100px; /* Above bottom nav */
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
            z-index: 1000;
            transform: translateY(200px); /* Start off-screen */
            transition: transform 0.3s ease;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .notification.show {
            transform: translateY(0); /* Slide in */
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            border-top: 2px solid #e9ecef;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            z-index: 999;
            flex-shrink: 0; /* Prevent bottom nav from shrinking */
        }

        .nav-item {
            flex: 1;
            padding: 20px 10px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            color: #666;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-item.active {
            color: #3498db; /* Blue for active icon/text */
            background: linear-gradient(135deg, #f8f9fa, #e9ecef); /* Light background for active */
        }

        /* Other elements */
        .time-display {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9em;
            margin-top: 10px;
            border-left: 4px solid #3498db;
        }

        .screen {
            display: none; /* Hide screens by default */
        }

        .screen.active {
            display: block; /* Show active screen */
        }

        .fare-display {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* Modals */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5); /* Semi-transparent overlay */
            z-index: 2000;
            animation: fadeIn 0.3s ease;
            display: flex; /* Use flexbox to center content */
            align-items: center; /* Vertically center */
            justify-content: center; /* Horizontally center */
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            /* margin: 10% auto; Removed as flexbox handles centering */
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: slideIn 0.3s ease;
            max-height: 90vh; /* Limit height to prevent overflow on very small screens */
            overflow-y: auto; /* Make modal content scrollable if it exceeds max-height */
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 2em;
            cursor: pointer;
            color: #999;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #e74c3c; /* Red on hover */
        }

        /* Form Inputs */
        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1.1em;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Responsive grid */
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Media Queries for smaller screens (e.g., keyboard open) */
        @media (max-height: 600px) {
            .big-button {
                padding: 15px;
                min-height: 60px;
                font-size: 1em;
            }
            
            .customer-buttons button {
                padding: 15px;
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>
    <div class="mobile-container">
        <div class="header">
            <h1>üöê KTransport360 Driver</h1>
            <p>Simple & Reliable Transport Management</p>
        </div>

        <div class="status-bar" id="statusBar">
            üì± App Ready - All data saved on your phone
        </div>

        <div class="main-content">
            <!-- Home Screen -->
            <div id="homeScreen" class="screen active">
                <div class="alert alert-success">
                    üì± <strong>READY TO GO!</strong><br>
                    Your transport app saves everything on your phone - no internet needed!
                </div>

                <div class="schedule-buttons">
                    <button class="big-button btn-today" onclick="showTodaysRides()">
                        üìÖ<br>TODAY'S<br>RIDES
                    </button>
                    <button class="big-button btn-tomorrow" onclick="showTomorrowsRides()">
                        üìÜ<br>TOMORROW'S<br>RIDES
                    </button>
                    <button class="big-button btn-future" onclick="showFutureRides()">
                        üîÆ<br>FUTURE<br>RIDES
                    </button>
                </div>

                <button class="big-button btn-add" onclick="showAddRideModal()">
                    ‚ûï Add New Ride
                </button>

                <button class="big-button btn-export" onclick="exportData()">
                    üìä Export Data for Spreadsheet
                </button>

                <div class="stats-grid" id="statsGrid">
                    <!-- Stats will be populated here -->
                </div>
            </div>

            <!-- Today's Rides Screen -->
            <div id="todaysScreen" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üìÖ Today's Rides</h2>
                    <div style="font-size: 1.1em; color: #666;" id="todaysDate"></div>
                </div>

                <div id="todaysRidesList">
                    <!-- Rides will be populated here -->
                </div>
            </div>

            <!-- Tomorrow's Rides Screen -->
            <div id="tomorrowsScreen" class="screen">
                <div style="display: flex; justify-content: space-between; align-align-items: center; margin-bottom: 20px;">
                    <h2>üìÜ Tomorrow's Rides</h2>
                    <div style="font-size: 1.1em; color: #666;" id="tomorrowsDate"></div>
                </div>

                <div id="tomorrowsRidesList">
                    <!-- Tomorrow's rides will be populated here -->
                </div>
            </div>

            <!-- Future Rides Screen (NEW) -->
            <div id="futureScreen" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üîÆ Future Rides</h2>
                    <!-- No specific date display here, as it's for multiple future dates -->
                </div>

                <div id="futureRidesList">
                    <!-- Future rides will be populated here -->
                </div>
            </div>
        </div>

        <!-- Add Ride Modal -->
        <div id="addRideModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>‚ûï Add New Ride</h2>
                
                <div class="input-group">
                    <label for="customerName">Customer Name</label>
                    <input type="text" id="customerName" placeholder="Enter customer name">
                </div>

                <div class="input-group">
                    <label for="customerPhone">Phone Number</label>
                    <input type="tel" id="customerPhone" placeholder="(904) 555-0123">
                </div>

                <div class="input-group">
                    <label for="pickupDate">Pickup Date</label>
                    <input type="date" id="pickupDate">
                </div>

                <div class="input-group">
                    <label for="pickupTime">Pickup Time</label>
                    <input type="time" id="pickupTime">
                </div>

                <div class="input-group">
                    <label for="pickupLocationInput">Pickup Location</label>
                    <!-- Changed from select to input with datalist for custom entries -->
                    <input type="text" id="pickupLocationInput" list="commonLocationsDatalist" placeholder="Select or type a pickup location">
                </div>

                <div class="input-group">
                    <label for="dropoffLocationInput">Drop-off Location</label>
                    <!-- Changed from select to input with datalist for custom entries -->
                    <input type="text" id="dropoffLocationInput" list="commonLocationsDatalist" placeholder="Select or type a drop-off location">
                </div>

                <div class="input-group">
                    <label for="fareAmount">Fare Amount</label>
                    <!-- Added id to make it easier to target for JavaScript -->
                    <input type="text" id="fareAmount" placeholder="$45.00">
                </div>

                <button class="big-button btn-add" onclick="saveNewRide()">
                    üíæ Save Ride
                </button>
            </div>
        </div>

        <!-- Notification -->
        <div id="notification" class="notification">
            üì± Ride saved!
        </div>

        <!-- This datalist provides autocomplete suggestions for location inputs -->
        <datalist id="commonLocationsDatalist"></datalist>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="showHome()">
                üè†<br>Home
            </button>
            <button class="nav-item" onclick="showTodaysRides()">
                üìÖ<br>Today
            </button>
            <button class="nav-item" onclick="showTomorrowsRides()">
                üìÜ<br>Tomorrow
            </button>
            <button class="nav-item" onclick="showFutureRides()">
                üîÆ<br>Future
            </button>
        </div>
    </div>

    <script>
        // *** IMPORTANT: If you see ReferenceErrors, ensure this script runs! ***
        // This log helps confirm the script is starting to execute.
        console.log('KTransport360 Script: Beginning execution...');

        // App Data Storage
        let ridesData = [];

        // Key for storing common locations in localStorage
        const COMMON_LOCATIONS_STORAGE_KEY = 'ktransport360_common_locations';

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App starting...');
            
            // Load data from localStorage (rides and common locations)
            loadData(); // Load rides data
            loadCommonLocationsData(); // Load/initialize common locations from localStorage/defaults
            
            // If no rides are loaded from localStorage, initialize with an empty list.
            if (ridesData.length === 0) {
                initializeSampleData(); // This function now ensures ridesData is empty
            }

            populateLocationSelects(); // Populate the datalist with common locations after they are loaded

            // Set up dates for display and default form value
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            document.getElementById('todaysDate').textContent = today.toLocaleDateString();
            document.getElementById('tomorrowsDate').textContent = tomorrow.toLocaleDateString();
            document.getElementById('pickupDate').value = today.toISOString().split('T')[0]; // Default new ride date to today
            
            // Initialize display
            updateStats();
            showHome(); // This will activate the home screen and initial stats display
            
            console.log('App initialized successfully');
            updateStatusBar(); // Initial status bar update with current time

            const fareAmountInput = document.getElementById('fareAmount');
            if (fareAmountInput) {
                // Event listener for live formatting as the user types
                fareAmountInput.addEventListener('input', function() {
                    let value = this.value.trim();
                    // Remove non-numeric characters, but allow one dot
                    value = value.replace(/[^\d.]/g, '');

                    // Handle decimal point correctly
                    const parts = value.split('.');
                    if (parts.length > 2) { // More than one decimal point
                        value = parts[0] + '.' + parts.slice(1).join('');
                    }

                    if (value === '') {
                        this.value = ''; // Keep empty if input is cleared
                        return;
                    }

                    if (value.startsWith('.')) { // User types .5
                        value = '0' + value;
                    }

                    // Prepend $ for display
                    if (!value.startsWith('$')) { // Only add $ if not already there
                         this.value = '$' + value;
                    } else {
                         this.value = value;
                    }
                });

                // Event listener for final formatting when the input loses focus
                fareAmountInput.addEventListener('blur', function() {
                    console.log('FareAmount blur event triggered. Current value before final format:', this.value);
                    let value = this.value.trim();
                    // Remove $ and any non-numeric characters except a single decimal point
                    value = value.replace(/[^\d.]/g, ''); 
                    
                    const fareNum = parseFloat(value);
                    if (!isNaN(fareNum)) {
                        this.value = `$${fareNum.toFixed(2)}`;
                    } else { // If not a number, or empty after stripping
                        this.value = '$0.00'; // Default to $0.00
                        showNotification('Invalid fare amount entered. Set to $0.00.');
                    }
                });
            } else {
                console.warn('Fare amount input element not found.');
            }
        });

        // Function to load common locations from localStorage or use defaults
        function loadCommonLocationsData() {
            try {
                const savedLocations = localStorage.getItem(COMMON_LOCATIONS_STORAGE_KEY);
                if (savedLocations) {
                    commonLocations = JSON.parse(savedLocations);
                    console.log('Common locations loaded from localStorage:', commonLocations.length, 'locations.');
                } else {
                    // Use the hardcoded list only if nothing is in localStorage
                    commonLocations = [
                        "Jacksonville International Airport (JAX)",
                        "Downtown Jacksonville",
                        "St. Johns Town Center",
                        "Mayo Clinic Jacksonville",
                        "Naval Air Station Jacksonville (NAS Jax)",
                        "Jacksonville Zoo and Gardens",
                        "TIAA Bank Field (EverBank Stadium)",
                        "Jacksonville Beach",
                        "Ponte Vedra Beach",
                        "St. Augustine Historic District",
                        "Orlando International Airport (MCO)",
                        "Walt Disney World Resort",
                        "Universal Orlando Resort",
                        "Daytona International Speedway",
                        "Gainesville, FL",
                        "Tallahassee, FL",
                        "Atlanta, GA",
                        "Savannah, GA",
                        "Miami International Airport (MIA)",
                        "Orlando Sanford International Airport (SFB)",
                        "Tampa International Airport (TPA)",
                        "Port Canaveral",
                        "Amelia Island",
                        "Palm Coast",
                        "Flagler Beach",
                        "Fernandina Beach",
                        "Orange Park",
                        "Fleming Island",
                        "Middleburg",
                        "Green Cove Springs",
                        "Starke",
                        "Palatka",
                        "Lake City",
                        "Brunswick, GA",
                        "Valdosta, GA"
                    ].sort();
                    saveCommonLocationsData(); // Save defaults once
                    console.log('Using default common locations and saving them.');
                }
            } catch (error) {
                console.error('Error loading common locations from localStorage:', error);
                // Fallback to hardcoded list if there's an error loading from storage
                // This ensures the app can still function even if storage is corrupted
                commonLocations = [
                    "Jacksonville International Airport (JAX)",
                    "Downtown Jacksonville",
                    "St. Johns Town Center",
                    "Mayo Clinic Jacksonville",
                    "Naval Air Station Jacksonville (NAS Jax)",
                    "Jacksonville Zoo and Gardens",
                    "TIAA Bank Field (EverBank Stadium)",
                    "Jacksonville Beach",
                    "Ponte Vedra Beach",
                    "St. Augustine Historic District",
                    "Orlando International Airport (MCO)",
                    "Walt Disney World Resort",
                    "Universal Orlando Resort",
                    "Daytona International Speedway",
                    "Gainesville, FL",
                    "Tallahassee, FL",
                    "Atlanta, GA",
                    "Savannah, GA",
                    "Miami International Airport (MIA)",
                    "Orlando Sanford International Airport (SFB)",
                    "Tampa International Airport (TPA)",
                    "Port Canaveral",
                    "Amelia Island",
                    "Palm Coast",
                    "Flagler Beach",
                    "Fernandina Beach",
                    "Orange Park",
                    "Fleming Island",
                    "Middleburg",
                    "Green Cove Springs",
                    "Starke",
                    "Palatka",
                    "Lake City",
                    "Brunswick, GA",
                    "Valdosta, GA"
                ].sort();
            }
        }

        // Function to save common locations to localStorage
        function saveCommonLocationsData() {
            try {
                localStorage.setItem(COMMON_LOCATIONS_STORAGE_KEY, JSON.stringify(commonLocations));
                console.log('Common locations saved to localStorage.');
            } catch (error) {
                console.error('Error saving common locations to localStorage:', error);
            }
        }

        // Load data from localStorage (this handles ridesData)
        function loadData() {
            try {
                const saved = localStorage.getItem('ktransport360_rides');
                if (saved) {
                    ridesData = JSON.parse(saved);
                    console.log('Rides data loaded:', ridesData.length, 'rides');
                } else {
                    ridesData = [];
                }
            }
            catch (error) {
                console.error('Error loading rides data from localStorage:', error);
                ridesData = []; // Reset if error occurs to prevent further issues
            }
        }

        // Initialize with sample data (clears current rides if none are loaded)
        function initializeSampleData() {
            ridesData = []; // Ensures the app starts with an empty ride list if no data is found
            saveData(); // Save the empty state immediately
            console.log('Sample data initialization complete: No initial rides.');
        }

        // Save rides data to localStorage
        function saveData() {
            try {
                localStorage.setItem('ktransport360_rides', JSON.stringify(ridesData));
                console.log('Rides data saved successfully to localStorage.');
            }
            catch (error) {
                console.error('Error saving rides data to localStorage:', error);
            }
        }

        // Helper function to add a location to commonLocations if it's new
        function addLocationIfNew(locationName) {
            if (!locationName || typeof locationName !== 'string' || locationName.trim() === "") {
                return; // Don't add empty or invalid strings
            }

            const normalizedName = locationName.trim();
            // Check if the location already exists (case-insensitive)
            const exists = commonLocations.some(loc => loc.toLowerCase() === normalizedName.toLowerCase());

            if (!exists) {
                commonLocations.push(normalizedName);
                commonLocations.sort(); // Keep the list sorted alphabetically
                saveCommonLocationsData(); // Persist the updated list
                console.log(`Added new location: "${normalizedName}" to common locations.`);
                showNotification(`‚ûï Added "${normalizedName}" to common locations!`);
                populateLocationSelects(); // Re-populate datalist with new option
            }
        }

        // --- Navigation Functions ---
        function hideAllScreens() {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
        }

        function setActiveNav(index) {
            document.querySelectorAll('.nav-item').forEach((item, i) => {
                if (i === index) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        function showHome() {
            console.log('Showing home screen.');
            hideAllScreens();
            document.getElementById('homeScreen').classList.add('active');
            setActiveNav(0);
            updateStats(); // Ensure stats are fresh when returning to home
        }

        function showTodaysRides() {
            console.log('Showing today\'s rides screen.');
            hideAllScreens();
            document.getElementById('todaysScreen').classList.add('active');
            setActiveNav(1);
            displayTodaysRides();
        }

        function showTomorrowsRides() {
            console.log('Showing tomorrow\'s rides screen.');
            hideAllScreens();
            document.getElementById('tomorrowsScreen').classList.add('active');
            setActiveNav(2);
            displayTomorrowsRides();
        }

        // Function to show Future Rides
        function showFutureRides() {
            console.log('Showing future rides screen.');
            hideAllScreens();
            document.getElementById('futureScreen').classList.add('active');
            setActiveNav(3); // Assuming this is the 4th item in bottom nav (0, 1, 2, 3)
            displayFutureRides();
        }

        // Update statistics on the home screen
        function updateStats() {
            console.log('Updating statistics.');
            const today = new Date().toISOString().split('T')[0];
            const todaysRides = ridesData.filter(ride => ride.date === today);
            
            const totalRides = todaysRides.length;
            const completed = todaysRides.filter(ride => ride.status === 'completed').length;
            
            let totalEarnings = 0;
            todaysRides.forEach(ride => {
                if (ride.status === 'completed' && ride.fare) {
                    const fareValue = parseFloat(ride.fare.replace('$', '')) || 0;
                    totalEarnings += fareValue;
                }
            });

            const statsGrid = document.getElementById('statsGrid');
            if (statsGrid) { // Check if element exists before updating
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${totalRides}</div>
                        <div class="stat-label">Today's Rides</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #27ae60, #229954);">
                        <div class="stat-number">${completed}</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                        <div class="stat-number">$${totalEarnings.toFixed(2)}</div>
                        <div class="stat-label">Earnings</div>
                    </div>
                `;
            } else {
                console.warn('Stats grid element not found for updating stats.');
            }
        }

        // Display today's rides in their dedicated section
        function displayTodaysRides() {
            console.log('Rendering today\'s rides.');
            const today = new Date().toISOString().split('T')[0];
            const todaysRides = ridesData
                                .filter(ride => ride.date === today)
                                .sort((a, b) => { // Sort by scheduledTime
                                    // Using a dummy date to compare times correctly
                                    const timeA = new Date(`1970/01/01 ${a.scheduledTime}`);
                                    const timeB = new Date(`1970/01/01 ${b.scheduledTime}`);
                                    return timeA - timeB;
                                });

            const container = document.getElementById('todaysRidesList');
            if (!container) {
                console.error('Element "todaysRidesList" not found.');
                return;
            }

            if (todaysRides.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        üìÖ <strong>No rides scheduled for today</strong><br>
                        Use "Add New Ride" to schedule rides
                    </div>
                `;
                return;
            }

            container.innerHTML = todaysRides.map(ride => createRideCard(ride)).join('');
        }

        // Display tomorrow's rides in their dedicated section
        function displayTomorrowsRides() {
            console.log('Rendering tomorrow\'s rides.');
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowDate = tomorrow.toISOString().split('T')[0];
            const tomorrowsRides = ridesData
                                    .filter(ride => ride.date === tomorrowDate)
                                    .sort((a, b) => { // Sort by scheduledTime
                                        const timeA = new Date(`1970/01/01 ${a.scheduledTime}`);
                                        const timeB = new Date(`1970/01/01 ${b.scheduledTime}`);
                                        return timeA - timeB;
                                    });

            const container = document.getElementById('tomorrowsRidesList');
            if (!container) {
                console.error('Element "tomorrowsRidesList" not found.');
                return;
            }

            if (tomorrowsRides.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        üìÜ <strong>No rides scheduled for tomorrow</strong><br>
                        Use "Add New Ride" to schedule future rides
                    </div>
                `;
                return;
            }

            container.innerHTML = tomorrowsRides.map(ride => createRideCard(ride)).join('');
        }

        // Display future rides (beyond tomorrow)
        function displayFutureRides() {
            console.log('Rendering future rides.');
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1); // Get tomorrow's date
            const dayAfterTomorrow = new Date(tomorrow);
            dayAfterTomorrow.setDate(tomorrow.getDate() + 1); // Get the day after tomorrow

            const futureRides = ridesData
                                .filter(ride => new Date(ride.date) >= dayAfterTomorrow) // Filter for rides starting from the day after tomorrow
                                .sort((a, b) => { // Sort by date, then by scheduledTime
                                    const dateA = new Date(a.date);
                                    const dateB = new Date(b.date);
                                    if (dateA.getTime() !== dateB.getTime()) {
                                        return dateA - dateB;
                                    }
                                    const timeA = new Date(`1970/01/01 ${a.scheduledTime}`);
                                    const timeB = new Date(`1970/01/01 ${b.scheduledTime}`);
                                    return timeA - timeB;
                                });

            const container = document.getElementById('futureRidesList');
            if (!container) {
                console.error('Element "futureRidesList" not found.');
                return;
            }

            if (futureRides.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        üîÆ <strong>No future rides scheduled</strong><br>
                        Use "Add New Ride" to schedule upcoming trips!
                    </div>
                `;
                return;
            }

            container.innerHTML = futureRides.map(ride => createRideCard(ride)).join('');
        }


        // Generates the HTML string for a single ride card
        function createRideCard(ride) {
            const statusClass = ride.status.replace('-', ''); // Converts 'picked-up' to 'pickedup' for CSS class
            let actionButtons = '';

            // Buttons only appear if the ride is for today or tomorrow and not completed
            const rideDate = new Date(ride.date).toISOString().split('T')[0];
            const today = new Date().toISOString().split('T')[0];
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowDate = tomorrow.toISOString().split('T')[0];

            if ((rideDate === today || rideDate === tomorrowDate) && ride.status === 'scheduled') {
                actionButtons = `
                    <button class="btn-pickup" onclick="pickupCustomer(${ride.id})">
                        üü¢ PICKED UP
                    </button>
                `;
            } else if ((rideDate === today || rideDate === tomorrowDate) && ride.status === 'picked-up') {
                actionButtons = `
                    <button class="btn-dropoff" onclick="dropoffCustomer(${ride.id})">
                        üîµ DROPPED OFF
                    </button>
                `;
            } else if (ride.status === 'completed') { // For completed rides, show a message
                actionButtons = `
                    <div style="text-align: center; color: #27ae60; font-weight: bold; font-size: 1.2em; padding: 20px;">
                        ‚úÖ RIDE COMPLETED
                    </div>
                `;
            } else { // For future scheduled rides, no buttons
                actionButtons = `
                    <div style="text-align: center; color: #3498db; font-weight: bold; font-size: 1.2em; padding: 20px;">
                        üìÖ SCHEDULED FOR ${new Date(ride.date).toLocaleDateString()}
                    </div>
                `;
            }


            return `
                <div class="customer-card ${ride.status === 'picked-up' ? 'active-ride' : ''} ${ride.status === 'completed' ? 'completed' : ''}">
                    <div class="customer-info">
                        <div class="customer-name">${ride.name}</div>
                        <div class="customer-details">üìû ${ride.phone}</div>
                        <div class="route-info">
                            <strong>‚è∞ ${ride.scheduledTime}</strong><br>
                            üìç <strong>From:</strong> ${ride.pickupLocation}<br>
                            üéØ <strong>To:</strong> ${ride.dropoffLocation}
                        </div>
                        ${ride.fare ? `<div class="fare-display">üí∞ Fare: ${ride.fare}</div>` : ''}
                        <span class="status-badge status-${statusClass}">${ride.status.replace('-', ' ').toUpperCase()}</span>
                        ${ride.pickupTime ? `<div class="time-display">üü¢ <strong>Picked up:</strong> ${ride.pickupTime}</div>` : ''}
                        ${ride.dropoffTime ? `<div class="time-display">üîµ <strong>Dropped off:</strong> ${ride.dropoffTime}</div>` : ''}
                    </div>
                    
                    <div class="customer-buttons">
                        ${actionButtons}
                    </div>
                </div>
            `;
        }

        // Handle customer pickup action
        function pickupCustomer(rideId) {
            console.log('Attempting pickup for ride ID:', rideId);
            const ride = ridesData.find(r => r.id === rideId);
            if (!ride) {
                console.error('Ride not found for pickup:', rideId);
                showNotification('‚ùå Error: Ride not found for pickup!'); // Use custom notification
                return;
            }

            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); // Format time clearly
            
            ride.pickupTime = timeString;
            ride.status = 'picked-up';
            
            saveData(); // Save changes to localStorage
            
            // Re-render the current active screen to reflect the status change
            if (document.getElementById('todaysScreen').classList.contains('active')) {
                displayTodaysRides();
            } else if (document.getElementById('tomorrowsScreen').classList.contains('active')) {
                displayTomorrowsRides();
            } else if (document.getElementById('futureScreen').classList.contains('active')) { // Re-render future rides if active
                displayFutureRides();
            }
            
            showNotification(`üü¢ ${ride.name} picked up at ${timeString}`);
            updateStats(); // Update earnings/completed rides
        }

        // Handle customer drop-off action
        function dropoffCustomer(rideId) {
            console.log('Attempting drop-off for ride ID:', rideId);
            const ride = ridesData.find(r => r.id === rideId);
            if (!ride) {
                console.error('Ride not found for drop-off:', rideId);
                showNotification('‚ùå Error: Ride not found for drop-off!'); // Use custom notification
                return;
            }

            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); // Format time clearly
            
            ride.dropoffTime = timeString;
            ride.status = 'completed';
            
            saveData(); // Save changes to localStorage
            
            // Re-render the current active screen to reflect the status change
            if (document.getElementById('todaysScreen').classList.contains('active')) {
                displayTodaysRides();
            } else if (document.getElementById('tomorrowsScreen').classList.contains('active')) {
                displayTomorrowsRides();
            } else if (document.getElementById('futureScreen').classList.contains('active')) { // Re-render future rides if active
                displayFutureRides();
            }
            
            showNotification(`üîµ ${ride.name} dropped off at ${timeString} - Trip completed!`);
            updateStats(); // Update earnings/completed rides
        }

        // Show the "Add New Ride" modal
        function showAddRideModal() {
            console.log('Opening add ride modal.');
            // Reset form fields when opening the modal for a clean start
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('pickupDate').value = new Date().toISOString().split('T')[0]; // Default to today
            document.getElementById('pickupTime').value = '';
            document.getElementById('fareAmount').value = '';

            // Populate the dropdowns with common locations
            populateLocationSelects();

            document.getElementById('addRideModal').style.display = 'flex'; /* Use flex to center */
        }

        // Function to populate the location dropdowns (now a datalist)
        function populateLocationSelects() {
            const datalist = document.getElementById('commonLocationsDatalist');
            // Clear previous options
            datalist.innerHTML = ''; 

            // Add common locations to the datalist
            if (commonLocations && commonLocations.length > 0) {
                commonLocations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location;
                    datalist.appendChild(option);
                });
            } else {
                console.warn('Common locations list is empty. Datalist will not have suggestions.');
            }
        }

        // Close the modal
        function closeModal() {
            console.log('Closing modal.');
            document.getElementById('addRideModal').style.display = 'none';
        }

        // Save a new ride entry from the modal form
        function saveNewRide() {
            console.log('Attempting to save new ride.');
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const date = document.getElementById('pickupDate').value;
            const time = document.getElementById('pickupTime').value;
            // Get values from the new input fields linked to the datalist
            const pickup = document.getElementById('pickupLocationInput').value.trim();
            const dropoff = document.getElementById('dropoffLocationInput').value.trim();
            const fare = document.getElementById('fareAmount').value.trim();

            // Basic validation
            if (!name || !phone || !date || !time || !pickup || !dropoff) {
                showNotification('‚ùå Please fill in all required fields, including locations!'); 
                return;
            }

            // Automatically add new locations to the common list if they are not already there
            if (pickup) {
                addLocationIfNew(pickup);
            }
            if (dropoff) {
                addLocationIfNew(dropoff);
            }

            // Format fare to ensure it has a $ sign and is a valid number (e.g., "$45.00")
            let formattedFare = '';
            const fareNum = parseFloat(fare.replace(/[^0-9.]/g, '')); // Remove non-numeric except dot
            if (!isNaN(fareNum)) {
                formattedFare = `$${fareNum.toFixed(2)}`;
            } else {
                formattedFare = '$0.00'; // Default to $0.00 if fare is invalid/empty
            }
            
            const newRide = {
                id: Date.now(), // Unique ID using current timestamp
                name: name,
                phone: phone,
                pickupLocation: pickup,
                dropoffLocation: dropoff,
                date: date,
                scheduledTime: formatTime(time),
                pickupTime: '',
                dropoffTime: '',
                fare: formattedFare,
                status: 'scheduled', // New rides start as 'scheduled'
                addedAt: new Date().toISOString()
            };

            ridesData.push(newRide); // Add new ride to the data array
            saveData(); // Persist the updated data

            closeModal(); // Close the form modal
            showNotification(`‚úÖ Ride scheduled for ${name}!`);
            updateStats(); // Update home screen statistics
            
            // Immediately refresh the relevant ride list if the new ride applies to it
            const today = new Date().toISOString().split('T')[0];
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowDate = tomorrow.toISOString().split('T')[0];

            if (date === today && document.getElementById('todaysScreen').classList.contains('active')) {
                displayTodaysRides();
            } else if (date === tomorrowDate && document.getElementById('tomorrowsScreen').classList.contains('active')) {
                displayTomorrowsRides();
            } else if (new Date(date) > new Date(tomorrowDate) && document.getElementById('futureScreen').classList.contains('active')) {
                displayFutureRides(); // Refresh future rides if adding a future ride while on that screen
            }
        }

        // Helper: Converts 24-hour time string to 12-hour format (e.g., "14:30" -> "2:30 PM")
        function formatTime(time24) {
            if (!time24) return '';
            const [hours, minutes] = time24.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12; // Handles 0 for midnight as 12 AM
            return `${hour12}:${minutes} ${ampm}`;
        }

        // Export data to clipboard and optionally as a file
        function exportData() {
            console.log('Initiating data export.');
            // Filter only completed rides for the export report
            const allCompletedRides = ridesData.filter(ride => ride.status === 'completed');

            if (allCompletedRides.length === 0) {
                showNotification('‚ÑπÔ∏è No completed rides to export yet!'); // Use custom notification
                return;
            }

            // Sort completed rides by date and then by dropoff time for better report order
            allCompletedRides.sort((a, b) => {
                const dateTimeA = new Date(`${a.date} ${a.dropoffTime}`);
                const dateTimeB = new Date(`${b.date} ${b.dropoffTime}`);
                return dateTimeA.getTime() - dateTimeB.getTime(); // Compare timestamps
            });


            // Construct the export text in a simple table-like format
            let exportText = "KTRANSPORT360 DAILY EXPORT\n";
            exportText += `Report Generated: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}\n\n`;
            exportText += "Customer Name | Phone | Pickup Location | Dropoff Location | Scheduled Time | Pickup Time | Dropoff Time | Fare | Ride Date\n";
            exportText += "=".repeat(150) + "\n"; // A long separator line

            allCompletedRides.forEach(ride => {
                // Ensure all fields are strings to avoid issues with join
                const row = [
                    ride.name,
                    ride.phone,
                    ride.pickupLocation,
                    ride.dropoffLocation,
                    ride.scheduledTime,
                    ride.pickupTime,
                    ride.dropoffTime,
                    ride.fare,
                    new Date(ride.date).toLocaleDateString() // Format date for readability
                ].join(' | ');
                exportText += row + '\n';
            });

            let totalEarnings = 0;
            allCompletedRides.forEach(ride => {
                if (ride.fare) {
                    totalEarnings += parseFloat(ride.fare.replace('$', '')) || 0;
                }
            });

            exportText += "\n" + "=".repeat(150) + "\n";
            exportText += `SUMMARY: ${allCompletedRides.length} completed rides | Total Earnings: $${totalEarnings.toFixed(2)}`;

            // Try to copy to clipboard using modern API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(exportText).then(() => {
                    showNotification('üìã Data copied to clipboard! Paste into your spreadsheet or notes app.');
                }).catch(err => {
                    console.error('Clipboard writeText failed, attempting fallback:', err);
                    fallbackCopyText(exportText);
                });
            } else {
                // Fallback for older browsers
                fallbackCopyText(exportText);
            }

            // After a short delay, ask if the user wants to download the file
            setTimeout(() => {
                // Using a custom modal/dialog here would be better than confirm()
                // For this example, we'll use confirm for simplicity, but note the instruction to avoid it.
                if (confirm('üíæ Would you like to download this data as a file too?')) {
                    downloadData(exportText, `KTransport360_Export_${new Date().toISOString().split('T')[0]}.txt`);
                }
            }, 2000);
        }

        // Fallback method for copying text to clipboard (for older browsers)
        function fallbackCopyText(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            // Make the textarea invisible and outside the viewport
            textArea.style.position = 'fixed'; 
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select(); // Select the text
            
            try {
                document.execCommand('copy'); // Execute the copy command
                showNotification('üìã Data copied (fallback)! Paste into your spreadsheet or notes app.');
            } catch (err) {
                console.error('Fallback copy failed:', err);
                showNotification('‚ùå Copy failed - Please manually select and copy the data.');
            } finally {
                document.body.removeChild(textArea); // Clean up the textarea
            }
        }

        // Initiates a file download
        function downloadData(content, filename) {
            try {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none'; // Hide the anchor element
                document.body.appendChild(a);
                a.click(); // Programmatically click to trigger download
                document.body.removeChild(a); // Clean up
                URL.revokeObjectURL(url); // Free up the object URL
                showNotification('üíæ File downloaded to your device!');
            } catch (error) {
                console.error('Error during file download:', error);
                showNotification('‚ùå Download failed.');
            }
        }

        // Displays a temporary notification message
        function showNotification(message) {
            const notification = document.getElementById('notification');
            if (!notification) {
                console.warn('Notification element not found. Cannot display notification:', message);
                return;
            }
            notification.textContent = message;
            notification.classList.add('show'); // Trigger CSS transition to show
            
            setTimeout(() => {
                notification.classList.remove('show'); // Hide after 4 seconds
            }, 4000);
        }

        // Event listener to close modal when clicking outside its content
        window.onclick = function(event) {
            const modal = document.getElementById('addRideModal');
            if (modal && event.target === modal) {
                closeModal();
            }
        };

        // Auto-save data to localStorage every 30 seconds
        setInterval(() => {
            saveData();
            saveCommonLocationsData(); // Also auto-save common locations
            console.log('Auto-saved data to localStorage.');
        }, 30000);

        // Update status bar with current time every minute
        function updateStatusBar() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const statusBar = document.getElementById('statusBar');
            if (statusBar) {
                statusBar.textContent = `üì± App Ready - Last updated: ${timeString}`;
            }
        }
        setInterval(updateStatusBar, 60000); // Update every minute

        // Global error handler for unhandled JavaScript errors
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Global JS Error Caught:');
            console.error('Message:', msg);
            console.error('URL:', url);
            console.error('Line:', lineNo, 'Column:', columnNo);
            console.error('Error Object:', error);
            // Optionally, show a more prominent error message to the user
            showNotification('Fatal Error! Check console for details. üö®');
            return false; // Suppress default browser error reporting
        };
    </script>
</body>
</html>
