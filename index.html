Absolutely! That's a great idea to show the actual pickup date in all ride cards. I'll add the calendar emoji and formatted date above the time in the route info section.

Here's the updated code with the date display added:

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>KTransport360 Driver App</title>
    <style>
        /* General Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* Removes tap highlight on mobile */
        }

        /* Body and Overall Layout */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* Purple-blue gradient */
            min-height: 100vh; /* Changed for consistent height */
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scroll */
            display: flex; /* Use flexbox for body to ensure mobile-container fills height */
            flex-direction: column; /* Stack children vertically */
        }

        .mobile-container {
            max-width: 100%;
            margin: 0;
            background: white;
            min-height: 100vh; /* Changed for consistent height */
            position: relative;
            display: flex; /* Make it a flex container */
            flex-direction: column; /* Arrange header, main, footer in a column */
            flex-grow: 1; /* Allow it to grow and fill body height */
            overflow: hidden; /* Hide overflow of the container itself, main-content will scroll */
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db); /* Dark blue to light blue gradient */
            color: white;
            padding: 20px 15px;
            text-align: center;
            position: sticky; /* Sticky header */
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            flex-shrink: 0; /* Prevent header from shrinking */
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Status Bar */
        .status-bar {
            background: #27ae60; /* Emerald green */
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1em;
            flex-shrink: 0; /* Prevent status bar from shrinking */
        }

        /* Main Content Area */
        .main-content {
            padding: 20px 15px;
            padding-bottom: 120px; /* Space for bottom nav */
            flex-grow: 1; /* Allows content to expand and take available space */
            overflow-y: auto; /* Adds scrollbar when content overflows vertically */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        /* Buttons */
        .schedule-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two columns for today/tomorrow buttons */
            gap: 15px;
            margin-bottom: 20px;
        }

        .big-button {
            width: 100%;
            padding: 25px 15px;
            margin: 10px 0;
            border: none;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            min-height: 80px; /* Ensure consistent height */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.3;
        }

        .big-button:active {
            transform: scale(0.95); /* Shrink effect on tap */
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .btn-today {
            background: linear-gradient(135deg, #27ae60, #229954); /* Green gradient */
            color: white;
        }

        .btn-tomorrow {
            background: linear-gradient(135deg, #3498db, #2980b9); /* Blue gradient */
            color: white;
        }

        .btn-add {
            background: linear-gradient(135deg, #9b59b6, #8e44ad); /* Purple gradient */
            color: white;
        }

        .btn-export {
            background: linear-gradient(135deg, #34495e, #2c3e50); /* Dark grey gradient */
            color: white;
        }

        .btn-future { /* New style for Future Rides button */
            background: linear-gradient(135deg, #e74c3c, #c0392b); /* Reddish gradient */
            color: white;
        }

        /* NEW: Style for Clear Completed Rides button */
        .btn-clear-completed {
            background: linear-gradient(135deg, #bdc3c7, #95a5a6); /* Light grey for clear */
            color: white;
        }

        /* Customer Ride Cards */
        .customer-card {
            background: white;
            border: 3px solid #e9ecef; /* Light grey border */
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .customer-card.active-ride {
            border-color: #27ae60; /* Green border for active rides */
            background: linear-gradient(135deg, #f8fff8, #f0fff0); /* Very light green background */
            animation: glow 3s infinite; /* Pulsing glow animation */
        }

        .customer-card.completed {
            border-color: #95a5a6; /* Grey border for completed rides */
            background: #f5f5f5; /* Light grey background */
            opacity: 0.8;
        }

        @keyframes glow {
            0%, 100% { 
                box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3); /* Green shadow */
                transform: translateY(0);
            }
            50% { 
                box-shadow: 0 8px 25px rgba(39, 174, 96, 0.5); /* Stronger green shadow */
                transform: translateY(-2px); /* Slight lift */
            }
        }

        .customer-info {
            margin-bottom: 20px;
        }

        .customer-name {
            font-size: 1.6em;
            font-weight: bold;
            color: #2c3e50; /* Dark blue-grey */
            margin-bottom: 10px;
        }

        .customer-details {
            font-size: 1.1em;
            line-height: 1.6;
            color: #555;
        }

        .route-info {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef); /* Very light grey gradient */
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 5px solid #3498db; /* Blue left border */
        }

        .customer-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .customer-buttons button {
            flex: 1; /* Distribute space evenly */
            padding: 20px;
            border: none;
            border-radius: 12px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        /* Specific button styles for pickup/dropoff, adjusted to match new layout */
        .btn-pickup {
            background: linear-gradient(135deg, #27ae60, #229954); /* Green gradient */
            color: white;
            font-size: 1.4em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .btn-dropoff {
            background: linear-gradient(135deg, #f39c12, #e67e22); /* Orange gradient */
            color: white;
            font-size: 1.4em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .btn-cancel {
            background: linear-gradient(135deg, #e74c3c, #c0392b); /* Red gradient */
            color: white;
            font-size: 1.4em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .btn-reschedule {
            background: linear-gradient(135deg, #9b59b6, #8e44ad); /* Purple gradient */
            color: white;
            font-size: 1.4em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 12px 20px;
            border-radius: 25px; /* Pill shape */
            font-size: 1em;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 15px;
        }

        .status-scheduled {
            background: linear-gradient(135deg, #3498db, #2980b9); /* Blue */
            color: white;
        }

        .status-picked-up { /* Corrected class name */
            background: linear-gradient(135deg, #27ae60, #229954); /* Green */
            color: white;
        }

        .status-completed {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d); /* Grey */
            color: white;
        }

        /* Alerts */
        .alert {
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
            font-size: 1.1em;
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb); /* Light green */
            color: #155724; /* Dark green text */
            border: 2px solid #c3e6cb;
        }

        .alert-info {
            background: linear-gradient(135deg, #cce7ff, #99d6ff); /* Light blue */
            color: #004085; /* Dark blue text */
            border: 2px solid #99d6ff;
        }

        /* Notifications (Toast-like) */
        .notification {
            position: fixed;
            bottom: 100px; /* Above bottom nav */
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
            z-index: 1000;
            transform: translateY(200px); /* Start off-screen */
            transition: transform 0.3s ease;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .notification.show {
            transform: translateY(0); /* Slide in */
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            border-top: 2px solid #e9ecef;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            z-index: 999;
            flex-shrink: 0; /* Prevent bottom nav from shrinking */
        }

        .nav-item {
            flex: 1;
            padding: 20px 10px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            color: #666;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-item.active {
            color: #3498db; /* Blue for active icon/text */
            background: linear-gradient(135deg, #f8f9fa, #e9ecef); /* Light background for active */
        }

        /* Other elements */
        .time-display {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9em;
            margin-top: 10px;
            border-left: 4px solid #3498db;
        }

        .screen {
            display: none; /* Hide screens by default */
        }

        .screen.active {
            display: block; /* Show active screen */
        }

        .fare-display {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* Modals */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5); /* Semi-transparent overlay */
            z-index: 2000;
            animation: fadeIn 0.3s ease;
            align-items: center; /* Vertically center */
            justify-content: center; /* Horizontally center */
        }

        .modal.show {
            display: flex; /* Use flexbox to center content */
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            /* margin: 10% auto; Removed as flexbox handles centering */
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: slideIn 0.3s ease;
            max-height: 90vh; /* Limit height to prevent overflow on very small screens */
            overflow-y: auto; /* Make modal content scrollable if it exceeds max-height */
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 2em;
            cursor: pointer;
            color: #999;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #e74c3c; /* Red on hover */
        }

        /* Form Inputs */
        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1.1em;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        /* NEW: Style for highlighting missing fields */
        .input-group input.missing-field,
        .input-group select.missing-field {
            border-color: #e74c3c !important; /* Red border */
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.4) !important; /* Red glow */
            background: #fffafa !important; /* Very light red background */
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Responsive grid */
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Media Queries for smaller screens (e.g., keyboard open) */
        @media (max-height: 600px) {
            .big-button {
                padding: 15px;
                min-height: 60px;
                font-size: 1em;
            }
            
            .customer-buttons button {
                padding: 15px;
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>
    <div class="mobile-container">
        <div class="header">
            <h1>🚐 KTransport360 Driver</h1>
            <p>Simple & Reliable Transport Management</p>
        </div>

        <div class="status-bar" id="statusBar">
            📱 App Ready - All data saved on your phone
        </div>

        <div class="main-content">
            <!-- Home Screen -->
            <div id="homeScreen" class="screen active">
                <div class="alert alert-success">
                    📱 <strong>READY TO GO!</strong><br>
                    Your transport app saves everything on your phone - no internet needed!
                </div>

                <div class="schedule-buttons">
                    <button class="big-button btn-today" onclick="showTodaysRides()">
                        📅<br>TODAY'S<br>RIDES
                    </button>
                    <button class="big-button btn-tomorrow" onclick="showTomorrowsRides()">
                        📆<br>TOMORROW'S<br>RIDES
                    </button>
                    <button class="big-button btn-future" onclick="showFutureRides()">
                        🔮<br>FUTURE<br>RIDES
                    </button>
                </div>

                <button class="big-button btn-add" onclick="showAddRideModal()">
                    ➕ Add New Ride
                </button>

                <button class="big-button btn-export" onclick="exportData()">
                    📊 Export Data for Spreadsheet
                </button>

                <button class="big-button btn-clear-completed" onclick="clearAllCompletedRides()">
                    🧹 Clear All Completed Rides
                </button>

                <div class="stats-grid" id="statsGrid">
                    <!-- Stats will be populated here -->
                </div>
            </div>

            <!-- Today's Rides Screen -->
            <div id="todaysScreen" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>📅 Today's Rides</h2>
                    <div style="font-size: 1.1em; color: #666;" id="todaysDate"></div>
                </div>

                <div id="todaysRidesList">
                    <!-- Rides will be populated here -->
                </div>
            </div>

            <!-- Tomorrow's Rides Screen -->
            <div id="tomorrowsScreen" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>📆 Tomorrow's Rides</h2>
                    <div style="font-size: 1.1em; color: #666;" id="tomorrowsDate"></div>
                </div>

                <div id="tomorrowsRidesList">
                    <!-- Tomorrow's rides will be populated here -->
                </div>
            </div>

            <!-- Future Rides Screen (NEW) -->
            <div id="futureScreen" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>🔮 Future Rides</h2>
                    <!-- No specific date display here, as it's for multiple future dates -->
                </div>

                <div id="futureRidesList">
                    <!-- Future rides will be populated here -->
                </div>
            </div>
        </div>

        <!-- Completed Rides Modal -->
        <div id="completedRidesModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeCompletedRidesModal()">&times;</span>
                <h2>✅ Today's Completed Rides</h2>
                <div id="completedRidesDetails">
                    <!-- Completed rides details will be populated here -->
                </div>
            </div>
        </div>

        <!-- Cancel Confirmation Modal -->
        <div id="cancelConfirmModal" class="modal">
            <div class="modal-content">
                <h2>❌ Cancel Ride</h2>
                <p id="cancelRideDetails" style="font-size: 1.1em; margin: 20px 0; text-align: center;"></p>
                <p style="color: #e74c3c; font-weight: bold; text-align: center;">This will permanently remove the ride from your schedule.</p>
                
                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button class="big-button" style="background: linear-gradient(135deg, #95a5a6, #7f8c8d); flex: 1;" onclick="closeCancelModal()">
                        Keep Scheduled
                    </button>
                    <button class="big-button btn-cancel" style="flex: 1;" onclick="confirmCancelRide()">
                        ❌ Remove Ride
                    </button>
                </div>
            </div>
        </div>

        <!-- Reschedule Ride Modal -->
        <div id="rescheduleRideModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeRescheduleModal()">&times;</span>
                <h2>📅 Reschedule Ride</h2>
                
                <div class="input-group">
                    <label for="rescheduleCustomerName">Customer Name</label>
                    <input type="text" id="rescheduleCustomerName" placeholder="Enter customer name">
                </div>

                <div class="input-group">
                    <label for="rescheduleCustomerPhone">Phone Number</label>
                    <input type="tel" id="rescheduleCustomerPhone" placeholder="(904) 555-0123">
                </div>

                <div class="input-group">
                    <label for="reschedulePickupDate">Pickup Date</label>
                    <input type="date" id="reschedulePickupDate">
                </div>

                <div class="input-group">
                    <label for="reschedulePickupTime">Pickup Time</label>
                    <input type="time" id="reschedulePickupTime">
                </div>

                <div class="input-group">
                    <label for="reschedulePickupLocationInput">Pickup Location</label>
                    <input type="text" id="reschedulePickupLocationInput" list="commonLocationsDatalist" placeholder="Select or type a pickup location">
                </div>

                <div class="input-group">
                    <label for="rescheduleDropoffLocationInput">Drop-off Location</label>
                    <input type="text" id="rescheduleDropoffLocationInput" list="commonLocationsDatalist" placeholder="Select or type a drop-off location">
                </div>

                <div class="input-group">
                    <label for="rescheduleFareAmount">Fare Amount</label>
                    <input type="text" id="rescheduleFareAmount" placeholder="$45.00">
                </div>

                <button class="big-button btn-reschedule" onclick="saveRescheduledRide()">
                    📅 Update Ride
                </button>
            </div>
        </div>

        <!-- Add Ride Modal -->
        <div id="addRideModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>➕ Add New Ride</h2>
                
                <div class="input-group">
                    <label for="customerName">Customer Name</label>
                    <input type="text" id="customerName" placeholder="Enter customer name">
                </div>

                <div class="input-group">
                    <label for="customerPhone">Phone Number</label>
                    <input type="tel" id="customerPhone" placeholder="(904) 555-0123">
                </div>

                <div class="input-group">
                    <label for="pickupDate">Pickup Date</label>
                    <input type="date" id="pickupDate">
                </div>

                <div class="input-group">
                    <label for="pickupTime">Pickup Time</label>
                    <input type="time" id="pickupTime">
                </div>

                <div class="input-group">
                    <label for="pickupLocationInput">Pickup Location</label>
                    <!-- Changed from select to input with datalist for custom entries -->
                    <input type="text" id="pickupLocationInput" list="commonLocationsDatalist" placeholder="Select or type a pickup location">
                </div>

                <div class="input-group">
                    <label for="dropoffLocationInput">Drop-off Location</label>
                    <!-- Changed from select to input with datalist for custom entries -->
                    <input type="text" id="dropoffLocationInput" list="commonLocationsDatalist" placeholder="Select or type a drop-off location">
                </div>

                <div class="input-group">
                    <label for="fareAmount">Fare Amount</label>
                    <!-- Added id to make it easier to target for JavaScript -->
                    <input type="text" id="fareAmount" placeholder="$45.00">
                </div>

                <button class="big-button btn-add" onclick="saveNewRide()">
                    💾 Save Ride
                </button>
            </div>
        </div>

        <!-- Notification -->
        <div id="notification" class="notification">
            📱 Ride saved!
        </div>

        <!-- This datalist provides autocomplete suggestions for location inputs -->
        <datalist id="commonLocationsDatalist"></datalist>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="showHome()">
                🏠<br>Home
            </button>
            <button class="nav-item" onclick="showTodaysRides()">
                📅<br>Today
            </button>
            <button class="nav-item" onclick="showTomorrowsRides()">
                📆<br>Tomorrow
            </button>
            <button class="nav-item" onclick="showFutureRides()">
                🔮<br>Future
            </button>
        </div>
    </div>

    <script>
        // *** IMPORTANT: If you see ReferenceErrors, ensure this script runs! ***
        // This log helps confirm the script is starting to execute.
        console.log('KTransport360 Script: Beginning execution...');

        // App Data Storage
        let ridesData = [];
        let commonLocations = [];
        let rideToCancel = null; // Store the ride being cancelled
        let rideToReschedule = null; // Store the ride being rescheduled

        // Key for storing common locations in localStorage
        const COMMON_LOCATIONS_STORAGE_KEY = 'ktransport360_common_locations';

        // Helper function to get local date string in YYYY-MM-DD format
        function getLocalDateString(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Helper function to get tomorrow's date string
        function getTomorrowDateString() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            return getLocalDateString(tomorrow);
        }

        // Helper function to get day after tomorrow's date string
        function getDayAfterTomorrowDateString() {
            const dayAfterTomorrow = new Date();
            dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 2);
            return getLocalDateString(dayAfterTomorrow);
        }

        // Helper function to format date for display (e.g., "June 12, 2025")
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            // Parse the YYYY-MM-DD format
            const dateParts = dateString.split('-');
            const year = parseInt(dateParts[0]);
            const month = parseInt(dateParts[1]) - 1; // JavaScript months are 0-indexed
            const day = parseInt(dateParts[2]);
            
            const date = new Date(year, month, day);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App starting...');
            
            // Load data from localStorage (rides and common locations)
            loadData(); // Load rides data (pending uploads are no longer loaded)
            loadCommonLocationsData(); // Load/initialize common locations from localStorage/defaults
            
            // If no rides are loaded from localStorage, initialize with an empty list.
            if (ridesData.length === 0) {
                initializeSampleData(); // This function now ensures ridesData is empty
            }

            populateLocationSelects(); // Populate the datalist with common locations after they are loaded

            // Set up dates for display and default form value
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            document.getElementById('todaysDate').textContent = today.toLocaleDateString();
            document.getElementById('tomorrowsDate').textContent = tomorrow.toLocaleDateString();
            document.getElementById('pickupDate').value = getLocalDateString(today); // Default new ride date to today
            
            // Initialize display
            updateStats();
            showHome(); // This will activate the home screen and initial stats display
            
            console.log('App initialized successfully');
            updateStatusBar(); // Initial status bar update with current time

            // Add event listeners for fare amount formatting - both add and reschedule modals
            setupFareFormatting('fareAmount');
            setupFareFormatting('rescheduleFareAmount');

            // Add event listeners for phone formatting - both add and reschedule modals
            setupPhoneFormatting('customerPhone');
            setupPhoneFormatting('rescheduleCustomerPhone');
        });

        // Setup fare amount formatting for a given input ID
        function setupFareFormatting(inputId) {
            const fareAmountInput = document.getElementById(inputId);
            if (fareAmountInput) {
                // Event listener for live formatting as the user types
                fareAmountInput.addEventListener('input', function() {
                    let value = this.value.trim();
                    // Remove non-numeric characters, but allow one dot
                    value = value.replace(/[^\d.]/g, '');

                    // Handle decimal point correctly
                    const parts = value.split('.');
                    if (parts.length > 2) { // More than one decimal point
                        value = parts[0] + '.' + parts.slice(1).join('');
                    }

                    if (value === '') {
                        this.value = ''; // Keep empty if input is cleared
                        return;
                    }

                    if (value.startsWith('.')) { // User types .5
                        value = '0' + value;
                    }

                    // Prepend $ for display
                    if (!value.startsWith('$')) { // Only add $ if not already there
                         this.value = '$' + value;
                    } else {
                         this.value = value;
                    }
                });

                // Event listener for final formatting when the input loses focus
                fareAmountInput.addEventListener('blur', function() {
                    console.log('FareAmount blur event triggered. Current value before final format:', this.value);
                    let value = this.value.trim();
                    // Remove $ and any non-numeric characters except a single decimal point
                    value = value.replace(/[^\d.]/g, ''); 
                    
                    const fareNum = parseFloat(value);
                    if (!isNaN(fareNum)) {
                        this.value = `$${fareNum.toFixed(2)}`;
                    } else { // If not a number, or empty after stripping
                        this.value = '$0.00'; // Default to $0.00
                        showNotification('Invalid fare amount entered. Set to $0.00.');
                    }
                });
            } else {
                console.warn(`Fare amount input element "${inputId}" not found.`);
            }
        }

        // Setup phone number formatting for a given input ID
        function setupPhoneFormatting(inputId) {
            const customerPhoneInput = document.getElementById(inputId);
            if (customerPhoneInput) {
                customerPhoneInput.addEventListener('input', function() {
                    let phoneNumber = this.value.replace(/\D/g, ''); // Remove all non-digits

                    let formattedPhoneNumber = '';
                    if (phoneNumber.length > 0) {
                        if (phoneNumber.length === 11 && phoneNumber.startsWith('1')) {
                            // Format for 1-(XXX) XXX-XXXX if 11 digits and starts with 1
                            formattedPhoneNumber = `1-(${phoneNumber.substring(1, 4)}) ${phoneNumber.substring(4, 7)}-${phoneNumber.substring(7, 11)}`;
                        } else if (phoneNumber.length >= 10) {
                            // Format for (XXX) XXX-XXXX if 10 digits
                            formattedPhoneNumber = `(${phoneNumber.substring(0, 3)}) ${phoneNumber.substring(3, 6)}-${phoneNumber.substring(6, 10)}`;
                        } else if (phoneNumber.length > 6) {
                            formattedPhoneNumber = `(${phoneNumber.substring(0, 3)}) ${phoneNumber.substring(3, 6)}-${phoneNumber.substring(6)}`;
                        } else if (phoneNumber.length > 3) {
                            formattedPhoneNumber = `(${phoneNumber.substring(0, 3)}) ${phoneNumber.substring(3)}`;
                        } else {
                            formattedPhoneNumber = phoneNumber; // Keep as-is for less than 3 digits
                        }
                    }
                    this.value = formattedPhoneNumber;
                });
            } else {
                console.warn(`Customer phone input element "${inputId}" not found.`);
            }
        }

        // Function to load common locations from localStorage or use defaults
        function loadCommonLocationsData() {
            try {
                const savedLocations = localStorage.getItem(COMMON_LOCATIONS_STORAGE_KEY);
                if (savedLocations) {
                    commonLocations = JSON.parse(savedLocations);
                    console.log('Common locations loaded from localStorage:', commonLocations.length, 'locations.');
                } else {
                    // Use the hardcoded list only if nothing is in localStorage
                    commonLocations = [
                        "Jacksonville International Airport (JAX)",
                        "Downtown Jacksonville",
                        "St. Johns Town Center",
                        "Mayo Clinic Jacksonville",
                        "Naval Air Station Jacksonville (NAS Jax)",
                        "Jacksonville Zoo and Gardens",
                        "TIAA Bank Field (EverBank Stadium)",
                        "Jacksonville Beach",
                        "Ponte Vedra Beach",
                        "St. Augustine Historic District",
                        "Orlando International Airport (MCO)",
                        "Walt Disney World Resort",
                        "Universal Orlando Resort",
                        "Daytona International Speedway",
                        "Gainesville, FL",
                        "Tallahassee, FL",
                        "Atlanta, GA",
                        "Savannah, GA",
                        "Miami International Airport (MIA)",
                        "Orlando Sanford International Airport (SFB)",
                        "Tampa International Airport (TPA)",
                        "Port Canaveral",
                        "Amelia Island",
                        "Palm Coast",
                        "Flagler Beach",
                        "Fernandina Beach",
                        "Orange Park",
                        "Fleming Island",
                        "Middleburg",
                        "Green Cove Springs",
                        "Starke",
                        "Palatka",
                        "Lake City",
                        "Brunswick, GA",
                        "Valdosta, GA"
                    ].sort();
                    saveCommonLocationsData(); // Save defaults once
                    console.log('Using default common locations and saving them.');
                }
            } catch (error) {
                console.error('Error loading common locations from localStorage:', error);
                // Fallback to hardcoded list if there's an error loading from storage
                // This ensures the app can still function even if storage is corrupted
                commonLocations = [
                    "Jacksonville International Airport (JAX)",
                    "Downtown Jacksonville",
                    "St. Johns Town Center",
                    "Mayo Clinic Jacksonville",
                    "Naval Air Station Jacksonville (NAS Jax)",
                    "Jacksonville Zoo and Gardens",
                    "TIAA Bank Field (EverBank Stadium)",
                    "Jacksonville Beach",
                    "Ponte Vedra Beach",
                    "St. Augustine Historic District",
                    "Orlando International Airport (MCO)",
                    "Walt Disney World Resort",
                    "Universal Orlando Resort",
                    "Daytona International Speedway",
                    "Gainesville, FL",
                    "Tallahassee, FL",
                    "Atlanta, GA",
                    "Savannah, GA",
                    "Miami International Airport (MIA)",
                    "Orlando Sanford International Airport (SFB)",
                    "Tampa International Airport (TPA)",
                    "Port Canaveral",
                    "Amelia Island",
                    "Palm Coast",
                    "Flagler Beach",
                    "Fernandina Beach",
                    "Orange Park",
                    "Fleming Island",
                    "Middleburg",
                    "Green Cove Springs",
                    "Starke",
                    "Palatka",
                    "Lake City",
                    "Brunswick, GA",
                    "Valdosta, GA"
                ].sort();
            }
        }

        // Function to save common locations to localStorage
        function saveCommonLocationsData() {
            try {
                localStorage.setItem(COMMON_LOCATIONS_STORAGE_KEY, JSON.stringify(commonLocations));
                console.log('Common locations saved to localStorage.');
            } catch (error) {
                console.error('Error saving common locations to localStorage:', error);
            }
        }

        // Load data from localStorage (this handles ridesData)
        function loadData() {
            try {
                const savedRides = localStorage.getItem('ktransport360_rides');
                if (savedRides) {
                    ridesData = JSON.parse(savedRides);
                    console.log('Rides data loaded:', ridesData.length, 'rides');
                } else {
                    ridesData = [];
                }
            }
            catch (error) {
                console.error('Error loading data from localStorage:', error);
                ridesData = []; // Reset if error occurs to prevent further issues
            }
        }

        // Initialize with sample data (clears current rides if none are loaded)
        function initializeSampleData() {
            ridesData = []; // Ensures the app starts with an empty ride list if no data is found
            saveData(); // Save the empty state immediately
            console.log('Sample data initialization complete: No initial rides.');
        }

        // Save rides data and common locations to localStorage
        function saveData() {
            try {
                localStorage.setItem('ktransport360_rides', JSON.stringify(ridesData));
                console.log('App data (rides) saved successfully to localStorage.'); // Updated log
            }
            catch (error) {
                console.error('Error saving app data to localStorage:', error);
            }
        }

        // Helper function to add a location to commonLocations if it's new
        function addLocationIfNew(locationName) {
            if (!locationName || typeof locationName !== 'string' || locationName.trim() === "") {
                return; // Don't add empty or invalid strings
            }

            const normalizedName = locationName.trim();
            // Check if the location already exists (case-insensitive)
            const exists = commonLocations.some(loc => loc.toLowerCase() === normalizedName.toLowerCase());

            if (!exists) {
                commonLocations.push(normalizedName);
                commonLocations.sort(); // Keep the list sorted alphabetically
                saveCommonLocationsData(); // Persist the updated list
                console.log(`Added new location: "${normalizedName}" to common locations!`);
                populateLocationSelects(); // Re-populate datalist with new option
            }
        }

        // --- Navigation Functions ---
        function hideAllScreens() {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
        }

        function setActiveNav(index) {
            document.querySelectorAll('.nav-item').forEach((item, i) => {
                if (i === index) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        function showHome() {
            console.log('Showing home screen.');
            hideAllScreens();
            document.getElementById('homeScreen').classList.add('active');
            setActiveNav(0);
            updateStats(); // Ensure stats are fresh when returning to home
        }

        function showTodaysRides() {
            console.log('Showing today\'s rides screen.');
            hideAllScreens();
            document.getElementById('todaysScreen').classList.add('active');
            setActiveNav(1);
            displayTodaysRides();
        }

        function showTomorrowsRides() {
            console.log('Showing tomorrow\'s rides screen.');
            hideAllScreens();
            document.getElementById('tomorrowsScreen').classList.add('active');
            setActiveNav(2);
            displayTomorrowsRides();
        }

        // Function to show Future Rides
        function showFutureRides() {
            console.log('Showing future rides screen.');
            hideAllScreens();
            document.getElementById('futureScreen').classList.add('active');
            setActiveNav(3); // Assuming this is the 4th item in bottom nav (0, 1, 2, 3)
            displayFutureRides();
        }

        // Update statistics on the home screen
        function updateStats() {
            console.log('Updating statistics.');
            const today = getLocalDateString();
            const todaysRides = ridesData.filter(ride => ride.date === today);
            
            const totalRides = todaysRides.length;
            const completed = todaysRides.filter(ride => ride.status === 'completed').length;
            
            let totalEarnings = 0;
            todaysRides.forEach(ride => {
                if (ride.status === 'completed' && ride.fare) {
                    const fareValue = parseFloat(ride.fare.replace('$', '')) || 0;
                    totalEarnings += fareValue;
                }
            });

            const statsGrid = document.getElementById('statsGrid');
            if (statsGrid) { // Check if element exists before updating
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${totalRides}</div>
                        <div class="stat-label">Today's Rides</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #27ae60, #229954); cursor: pointer;" onclick="showCompletedRides()">
                        <div class="stat-number">${completed}</div>
                        <div class="stat-label">Completed (Click for Details)</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                        <div class="stat-number">$${totalEarnings.toFixed(2)}</div>
                        <div class="stat-label">Earnings</div>
                    </div>
                `;
            } else {
                console.warn('Stats grid element not found for updating stats.');
            }
        }

        // Display today's rides in their dedicated section
        function displayTodaysRides() {
            console.log('Rendering today\'s rides.');
            const today = getLocalDateString();
            const todaysRides = ridesData
                                .filter(ride => ride.date === today)
                                .sort((a, b) => { // Sort by scheduledTime
                                    const timeA = new Date(`1970/01/01 ${a.scheduledTime}`).getTime();
                                    const timeB = new Date(`1970/01/01 ${b.scheduledTime}`).getTime();
                                    return timeA - timeB;
                                });

            const container = document.getElementById('todaysRidesList');
            if (!container) {
                console.error('Element "todaysRidesList" not found.');
                return;
            }

            if (todaysRides.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        📅 <strong>No rides scheduled for today</strong><br>
                        Use "Add New Ride" to schedule rides
                    </div>
                `;
                return;
            }

            // Check for missed rides and apply highlighting
            container.innerHTML = todaysRides.map(ride => {
                let isMissed = false;
                if (ride.status === 'scheduled') {
                    const rideDateTime = new Date(`${ride.date}T${ride.scheduledTime}`);
                    // Only mark as missed if the ride date is today AND the scheduled time is in the past
                    // OR if the ride date is before today
                    if (rideDateTime.getTime() < new Date().getTime()) {
                        isMissed = true;
                    }
                }
                return createRideCard(ride, isMissed); // Pass isMissed status to createRideCard
            }).join('');
        }


        // Display tomorrow's rides in their dedicated section
        function displayTomorrowsRides() {
            console.log('Rendering tomorrow\'s rides.');
            const tomorrowDate = getTomorrowDateString();
            console.log('Tomorrow date string:', tomorrowDate); // Debug log
            
            const tomorrowsRides = ridesData
                                    .filter(ride => {
                                        console.log('Checking ride date:', ride.date, 'against tomorrow:', tomorrowDate); // Debug log
                                        return ride.date === tomorrowDate;
                                    })
                                    .sort((a, b) => { // Sort by scheduledTime
                                        const timeA = new Date(`1970/01/01 ${a.scheduledTime}`).getTime();
                                        const timeB = new Date(`1970/01/01 ${b.scheduledTime}`).getTime();
                                        return timeA - timeB;
                                    });

            console.log('Tomorrow\'s rides found:', tomorrowsRides.length); // Debug log

            const container = document.getElementById('tomorrowsRidesList');
            if (!container) {
                console.error('Element "tomorrowsRidesList" not found.');
                return;
            }

            if (tomorrowsRides.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        📆 <strong>No rides scheduled for tomorrow</strong><br>
                        Use "Add New Ride" to schedule future rides
                    </div>
                `;
                return;
            }

            container.innerHTML = tomorrowsRides.map(ride => createRideCard(ride, false)).join(''); // No missed rides for tomorrow
        }

        // Display future rides (beyond tomorrow)
        function displayFutureRides() {
            console.log('Rendering future rides.');
            const dayAfterTomorrowString = getDayAfterTomorrowDateString();
            console.log('Day after tomorrow string:', dayAfterTomorrowString); // Debug log

            const futureRides = ridesData
                                .filter(ride => {
                                    console.log('Checking ride date:', ride.date, 'against day after tomorrow:', dayAfterTomorrowString); // Debug log
                                    return ride.date >= dayAfterTomorrowString; // String comparison for dates >= day after tomorrow
                                })
                                .sort((a, b) => { // Sort by date string, then by scheduledTime
                                    if (a.date !== b.date) {
                                        return a.date.localeCompare(b.date); // String comparison for dates
                                    }
                                    const timeA = new Date(`1970/01/01 ${a.scheduledTime}`).getTime();
                                    const timeB = new Date(`1970/01/01 ${b.scheduledTime}`).getTime();
                                    return timeA - timeB;
                                });

            console.log('Future rides found:', futureRides.length); // Debug log

            const container = document.getElementById('futureRidesList');
            if (!container) {
                console.error('Element "futureRidesList" not found.');
                return;
            }

            if (futureRides.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        🔮 <strong>No future rides scheduled</strong><br>
                        Use "Add New Ride" to schedule upcoming trips!
                    </div>
                `;
                return;
            }

            container.innerHTML = futureRides.map(ride => createRideCard(ride, false)).join(''); // No missed rides for future
        }


        // Generates the HTML string for a single ride card
        function createRideCard(ride, isMissed = false) {
            const statusClass = ride.status.replace('-', ''); // Converts 'picked-up' to 'pickedup' for CSS class
            let actionButtons = '';
            let missedTag = '';
            let cardClasses = `${ride.status === 'picked-up' ? 'active-ride' : ''} ${ride.status === 'completed' ? 'completed' : ''}`;

            // Add 'missed-ride' class if it's a missed ride
            if (isMissed) {
                cardClasses += ' missed-ride';
                missedTag = `
                    <div style="text-align: center; color: #e74c3c; font-weight: bold; font-size: 1.1em; padding-bottom: 10px;">
                        🚨 ACTION REQUIRED: RIDE MISSED!
                    </div>
                `;
            }

            // Determine which day this ride is for using our helper functions
            const rideDate = ride.date;
            const today = getLocalDateString();
            const tomorrowDate = getTomorrowDateString();

            // Format the pickup date for display
            const formattedPickupDate = formatDateForDisplay(ride.date);

            // Different button logic based on the day and status
            if (rideDate === today) { // TODAY'S RIDES
                if (ride.status === 'scheduled' && !isMissed) {
                    actionButtons = `
                        <button class="btn-pickup" onclick="pickupCustomer(${ride.id})">
                            🟢 PICKED UP
                        </button>
                        <button class="btn-cancel" onclick="cancelRide(${ride.id})">
                            ❌ CANCEL
                        </button>
                    `;
                } else if (ride.status === 'picked-up') {
                    actionButtons = `
                        <button class="btn-dropoff" onclick="dropoffCustomer(${ride.id})">
                            🔵 DROPPED OFF
                        </button>
                    `;
                }
            } else if (rideDate === tomorrowDate || rideDate > tomorrowDate) { // TOMORROW'S RIDES OR FUTURE RIDES
                if (ride.status === 'scheduled') {
                    actionButtons = `
                        <button class="btn-reschedule" onclick="rescheduleRide(${ride.id})">
                            📅 RESCHEDULE
                        </button>
                        <button class="btn-cancel" onclick="cancelRide(${ride.id})">
                            ❌ CANCEL
                        </button>
                    `;
                }
            }

            // If no buttons were set (completed rides, missed rides), show status info
            if (!actionButtons) {
                actionButtons = `
                    <div style="text-align: center; color: #3498db; font-weight: bold; font-size: 1.2em; padding: 20px;">
                        📅 SCHEDULED FOR ${formattedPickupDate}
                    </div>
                `;
            }

            return `
                <div class="customer-card ${cardClasses}">
                    ${missedTag}
                    <div class="customer-info">
                        <div class="customer-name">${ride.name}</div>
                        <div class="customer-details">📞 ${ride.phone}</div>
                        <div class="route-info">
                            📅 <strong>${formattedPickupDate}</strong><br>
                            <strong>⏰ ${ride.scheduledTime}</strong><br>
                            📍 <strong>From:</strong> ${ride.pickupLocation}<br>
                            🎯 <strong>To:</strong> ${ride.dropoffLocation}
                        </div>
                        ${ride.fare ? `<div class="fare-display">💰 Fare: ${ride.fare}</div>` : ''}
                        <span class="status-badge status-${statusClass}">${ride.status.replace('-', ' ').toUpperCase()}</span>
                        ${ride.pickupTime ? `<div class="time-display">🟢 <strong>Picked up:</strong> ${ride.pickupTime}</div>` : ''}
                        ${ride.dropoffTime ? `<div class="time-display">🔵 <strong>Dropped off:</strong> ${ride.dropoffTime}</div>` : ''}
                    </div>
                    
                    <div class="customer-buttons">
                        ${actionButtons}
                    </div>
                </div>
            `;
        }

        // Handle customer pickup action
        function pickupCustomer(rideId) {
            console.log('Attempting pickup for ride ID:', rideId);
            const ride = ridesData.find(r => r.id === rideId);
            if (!ride) {
                console.error('Ride not found for pickup:', rideId);
                showNotification('❌ Error: Ride not found for pickup!'); // Use custom notification
                return;
            }

            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); // Format time clearly
            
            ride.pickupTime = timeString;
            ride.status = 'picked-up';
            
            saveData(); // Save changes to localStorage
            
            // Re-render the current active screen to reflect the status change
            if (document.getElementById('todaysScreen').classList.contains('active')) {
                displayTodaysRides();
            } else if (document.getElementById('tomorrowsScreen').classList.contains('active')) {
                displayTomorrowsRides();
            } else if (document.getElementById('futureScreen').classList.contains('active')) { // Re-render future rides if active
                displayFutureRides();
            }
            
            showNotification(`🟢 ${ride.name} picked up at ${timeString}`);
            updateStats(); // Update earnings/completed rides
        }

        // Handle customer drop-off action
        async function dropoffCustomer(rideId) { 
            console.log('Attempting drop-off for ride ID:', rideId);
            const ride = ridesData.find(r => r.id === rideId);
            if (!ride) {
                console.error('Ride not found for drop-off:', rideId);
                showNotification('❌ Error: Ride not found for drop-off!'); // Use custom notification
                return;
            }

            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); // Format time clearly
            
            ride.dropoffTime = timeString;
            ride.status = 'completed';
            
            saveData(); // Save changes to localStorage
            
            // Re-render the current active screen to reflect the status change
            if (document.getElementById('todaysScreen').classList.contains('active')) {
                displayTodaysRides();
            } else if (document.getElementById('tomorrowsScreen').classList.contains('active')) {
                displayTomorrowsRides();
            } else if (document.getElementById('futureScreen').classList.contains('active')) { // Re-render future rides if active
                displayFutureRides();
            }
            
            showNotification(`🔵 ${ride.name} dropped off at ${timeString} - Trip completed!`);
            updateStats(); // Update earnings/completed rides
        }

        // Handle ride cancellation action
        function cancelRide(rideId) {
            console.log('Attempting to cancel ride ID:', rideId);
            const ride = ridesData.find(r => r.id === rideId);
            if (!ride) {
                console.error('Ride not found for cancellation:', rideId);
                showNotification('❌ Error: Ride not found for cancellation!');
                return;
            }

            // Store the ride to cancel and show custom confirmation modal
            rideToCancel = ride;
            document.getElementById('cancelRideDetails').textContent = `Cancel ride for ${ride.name}?`;
            document.getElementById('cancelConfirmModal').classList.add('show');
        }

        // Close the cancel confirmation modal
        function closeCancelModal() {
            document.getElementById('cancelConfirmModal').classList.remove('show');
            rideToCancel = null;
            showNotification('Cancellation aborted - ride remains scheduled');
        }

        // Confirm and execute the ride cancellation
        function confirmCancelRide() {
            if (!rideToCancel) {
                showNotification('❌ Error: No ride selected for cancellation');
                return;
            }

            // Remove the ride from ridesData array
            const rideIndex = ridesData.findIndex(r => r.id === rideToCancel.id);
            if (rideIndex > -1) {
                const rideName = rideToCancel.name;
                ridesData.splice(rideIndex, 1);
                saveData(); // Save changes to localStorage
                
                // Close the modal
                document.getElementById('cancelConfirmModal').classList.remove('show');
                rideToCancel = null;
                
                // Re-render the current active screen to reflect the change
                if (document.getElementById('todaysScreen').classList.contains('active')) {
                    displayTodaysRides();
                } else if (document.getElementById('tomorrowsScreen').classList.contains('active')) {
                    displayTomorrowsRides();
                } else if (document.getElementById('futureScreen').classList.contains('active')) {
                    displayFutureRides();
                }
                
                showNotification(`❌ Ride for ${rideName} has been cancelled and removed from schedule`);
                updateStats(); // Update stats since ride count changed
            } else {
                showNotification('❌ Error: Could not remove ride from schedule');
                document.getElementById('cancelConfirmModal').classList.remove('show');
                rideToCancel = null;
            }
        }

        // Handle ride reschedule action
        function rescheduleRide(rideId) {
            console.log('Attempting to reschedule ride ID:', rideId);
            const ride = ridesData.find(r => r.id === rideId);
            if (!ride) {
                console.error('Ride not found for rescheduling:', rideId);
                showNotification('❌ Error: Ride not found for rescheduling!');
                return;
            }

            // Store the ride to reschedule and populate the form
            rideToReschedule = ride;
            
            // Pre-fill the reschedule form with current ride data
            document.getElementById('rescheduleCustomerName').value = ride.name;
            document.getElementById('rescheduleCustomerPhone').value = ride.phone;
            document.getElementById('reschedulePickupDate').value = ride.date;
            
            // Convert scheduled time back to 24-hour format for the time input
            const time24 = convertTo24Hour(ride.scheduledTime);
            document.getElementById('reschedulePickupTime').value = time24;
            
            document.getElementById('reschedulePickupLocationInput').value = ride.pickupLocation;
            document.getElementById('rescheduleDropoffLocationInput').value = ride.dropoffLocation;
            document.getElementById('rescheduleFareAmount').value = ride.fare;

            // Clear any previous highlighting
            document.querySelectorAll('.missing-field').forEach(el => {
                el.classList.remove('missing-field');
            });

            // Show the reschedule modal
            document.getElementById('rescheduleRideModal').classList.add('show');
        }

        // Helper function to convert 12-hour time to 24-hour format (e.g., "2:30 PM" -> "14:30")
        function convertTo24Hour(time12) {
            if (!time12) return '';
            
            const [time, modifier] = time12.split(' ');
            let [hours, minutes] = time.split(':');
            
            if (hours === '12') {
                hours = '00';
            }
            
            if (modifier === 'PM') {
                hours = parseInt(hours, 10) + 12;
            }
            
            return `${hours.toString().padStart(2, '0')}:${minutes}`;
        }

        // Close the reschedule modal
        function closeRescheduleModal() {
            document.getElementById('rescheduleRideModal').classList.remove('show');
            rideToReschedule = null;
            showNotification('Reschedule cancelled - ride remains as originally scheduled');
        }

        // Save the rescheduled ride
        function saveRescheduledRide() {
            console.log('Attempting to save rescheduled ride.');
            
            if (!rideToReschedule) {
                showNotification('❌ Error: No ride selected for rescheduling');
                return;
            }

            // Get references to reschedule input elements
            const customerNameInput = document.getElementById('rescheduleCustomerName');
            const customerPhoneInput = document.getElementById('rescheduleCustomerPhone');
            const pickupDateInput = document.getElementById('reschedulePickupDate');
            const pickupTimeInput = document.getElementById('reschedulePickupTime');
            const pickupLocationInput = document.getElementById('reschedulePickupLocationInput');
            const dropoffLocationInput = document.getElementById('rescheduleDropoffLocationInput');
            const fareAmountInput = document.getElementById('rescheduleFareAmount');

            // Get trimmed values
            const name = customerNameInput.value.trim();
            const phone = customerPhoneInput.value.trim();
            const date = pickupDateInput.value;
            const time = pickupTimeInput.value;
            const pickup = pickupLocationInput.value.trim();
            const dropoff = dropoffLocationInput.value.trim();
            const fare = fareAmountInput.value.trim();

            let missingFields = false; // Flag to track if any fields are missing

            // Clear previous highlighting
            document.querySelectorAll('.missing-field').forEach(el => {
                el.classList.remove('missing-field');
            });

            // Basic validation and highlighting
            if (!name) {
                customerNameInput.classList.add('missing-field');
                missingFields = true;
            }
            if (!phone) {
                customerPhoneInput.classList.add('missing-field');
                missingFields = true;
            }
            if (!date) {
                pickupDateInput.classList.add('missing-field');
                missingFields = true;
            }
            if (!time) {
                pickupTimeInput.classList.add('missing-field');
                missingFields = true;
            }
            if (!pickup) {
                pickupLocationInput.classList.add('missing-field');
                missingFields = true;
            }
            if (!dropoff) {
                dropoffLocationInput.classList.add('missing-field');
                missingFields = true;
            }

            if (missingFields) {
                showNotification('❌ Please fill in all highlighted fields!'); 
                return; // Stop the function if fields are missing
            }

            // Automatically add new locations to the common list if they are not already there
            if (pickup) {
                addLocationIfNew(pickup);
            }
            if (dropoff) {
                addLocationIfNew(dropoff);
            }

            // Format fare to ensure it has a $ sign and is a valid number (e.g., "$45.00")
            let formattedFare = '';
            const fareNum = parseFloat(fare.replace(/[^0-9.]/g, '')); // Remove non-numeric except dot
            if (!isNaN(fareNum)) {
                formattedFare = `$${fareNum.toFixed(2)}`;
            } else {
                formattedFare = '$0.00'; // Default to $0.00 if fare is invalid/empty
            }
            
            // Update the existing ride with new information
            rideToReschedule.name = name;
            rideToReschedule.phone = phone;
            rideToReschedule.pickupLocation = pickup;
            rideToReschedule.dropoffLocation = dropoff;
            rideToReschedule.date = date;
            rideToReschedule.scheduledTime = formatTime(time);
            rideToReschedule.fare = formattedFare;
            // Keep the same ID and other properties
            
            saveData(); // Persist the updated data

            closeRescheduleModal(); // Close the reschedule modal
            showNotification(`📅 Ride for ${name} has been rescheduled!`);
            updateStats(); // Update home screen statistics
            
            // Refresh all ride screens since the ride may have moved between days
            displayTodaysRides();
            displayTomorrowsRides();
            displayFutureRides();
        }

        // Show completed rides details modal
        function showCompletedRides() {
            console.log('Showing completed rides details');
            const today = getLocalDateString();
            const completedRides = ridesData.filter(ride => ride.date === today && ride.status === 'completed');
            
            if (completedRides.length === 0) {
                showNotification('ℹ️ No completed rides for today yet!');
                return;
            }

            // Sort completed rides by dropoff time
            completedRides.sort((a, b) => {
                const timeA = new Date(`1970/01/01 ${a.dropoffTime}`).getTime();
                const timeB = new Date(`1970/01/01 ${b.dropoffTime}`).getTime();
                return timeA - timeB;
            });

            let totalEarnings = 0;
            let ridesHtml = '';
            
            completedRides.forEach((ride, index) => {
                const fareValue = parseFloat(ride.fare.replace('$', '')) || 0;
                totalEarnings += fareValue;
                
                ridesHtml += `
                    <div class="customer-card completed" style="margin: 15px 0;">
                        <div class="customer-info">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div class="customer-name">${ride.name}</div>
                                <div style="font-size: 1.1em; color: #27ae60; font-weight: bold;">#${index + 1}</div>
                            </div>
                            <div class="customer-details">📞 ${ride.phone}</div>
                            <div class="route-info">
                                📅 <strong>${formatDateForDisplay(ride.date)}</strong><br>
                                <strong>⏰ Scheduled: ${ride.scheduledTime}</strong><br>
                                📍 <strong>From:</strong> ${ride.pickupLocation}<br>
                                🎯 <strong>To:</strong> ${ride.dropoffLocation}
                            </div>
                            <div class="fare-display">💰 Fare: ${ride.fare}</div>
                            <div class="time-display">🟢 <strong>Picked up:</strong> ${ride.pickupTime}</div>
                            <div class="time-display">🔵 <strong>Dropped off:</strong> ${ride.dropoffTime}</div>
                        </div>
                    </div>
                `;
            });

            // Add summary at the top
            const summaryHtml = `
                <div class="alert alert-success" style="margin-bottom: 20px;">
                    📊 <strong>TODAY'S SUMMARY</strong><br>
                    ${completedRides.length} completed rides • Total earnings: $${totalEarnings.toFixed(2)}
                </div>
            `;

            document.getElementById('completedRidesDetails').innerHTML = summaryHtml + ridesHtml;
            document.getElementById('completedRidesModal').classList.add('show');
        }

        // Close completed rides modal
        function closeCompletedRidesModal() {
            document.getElementById('completedRidesModal').classList.remove('show');
        }

        // Show the "Add New Ride" modal
        function showAddRideModal() {
            console.log('Opening add ride modal.');
            // Reset form fields when opening the modal for a clean start
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('pickupDate').value = getLocalDateString(); // Default to today
            document.getElementById('pickupTime').value = '';
            document.getElementById('fareAmount').value = '';

            // Clear any previous highlighting
            document.querySelectorAll('.missing-field').forEach(el => {
                el.classList.remove('missing-field');
            });

            // Populate the dropdowns with common locations
            populateLocationSelects();

            document.getElementById('addRideModal').classList.add('show');
        }

        // Function to populate the location dropdowns (now a datalist)
        function populateLocationSelects() {
            const datalist = document.getElementById('commonLocationsDatalist');
            // Clear previous options
            datalist.innerHTML = ''; 

            // Add common locations to the datalist
            if (commonLocations && commonLocations.length > 0) {
                commonLocations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location;
                    datalist.appendChild(option);
                });
            } else {
                console.warn('Common locations list is empty. Datalist will not have suggestions.');
            }
        }

        // Close the modal
        function closeModal() {
            console.log('Closing modal.');
            document.getElementById('addRideModal').classList.remove('show');
        }

        // Save a new ride entry from the modal form
        function saveNewRide() {
            console.log('Attempting to save new ride.');
            // Get references to input elements
            const customerNameInput = document.getElementById('customerName');
            const customerPhoneInput = document.getElementById('customerPhone');
            const pickupDateInput = document.getElementById('pickupDate');
            const pickupTimeInput = document.getElementById('pickupTime');
            const pickupLocationInput = document.getElementById('pickupLocationInput');
            const dropoffLocationInput = document.getElementById('dropoffLocationInput');
            const fareAmountInput = document.getElementById('fareAmount');

            // Get trimmed values
            const name = customerNameInput.value.trim();
            const phone = customerPhoneInput.value.trim();
            const date = pickupDateInput.value;
            const time = pickupTimeInput.value;
            const pickup = pickupLocationInput.value.trim();
            const dropoff = dropoffLocationInput.value.trim();
            const fare = fareAmountInput.value.trim();

            let missingFields = false; // Flag to track if any fields are missing

            // Clear previous highlighting
            document.querySelectorAll('.missing-field').forEach(el => {
                el.classList.remove('missing-field');
            });

            // Basic validation and highlighting
            if (!name) {
                customerNameInput.classList.add('missing-field');
                missingFields = true;
            }
            if (!phone) {
                customerPhoneInput.classList.add('missing-field');
                missingFields = true;
            }
            if (!date) {
                pickupDateInput.classList.add('missing-field');
                missingFields = true;
            }
            if (!time) {
                pickupTimeInput.classList.add('missing-field');
                missingFields = true;
            }
            if (!pickup) {
                pickupLocationInput.classList.add('missing-field');
                missingFields = true;
            }
            if (!dropoff) {
                dropoffLocationInput.classList.add('missing-field');
                missingFields = true;
            }

            if (missingFields) {
                showNotification('❌ Please fill in all highlighted fields!'); 
                return; // Stop the function if fields are missing
            }

            // Automatically add new locations to the common list if they are not already there
            if (pickup) {
                addLocationIfNew(pickup);
            }
            if (dropoff) {
                addLocationIfNew(dropoff);
            }

            // Format fare to ensure it has a $ sign and is a valid number (e.g., "$45.00")
            let formattedFare = '';
            const fareNum = parseFloat(fare.replace(/[^0-9.]/g, '')); // Remove non-numeric except dot
            if (!isNaN(fareNum)) {
                formattedFare = `$${fareNum.toFixed(2)}`;
            } else {
                formattedFare = '$0.00'; // Default to $0.00 if fare is invalid/empty
            }
            
            const newRide = {
                id: Date.now(), // Unique ID using current timestamp
                name: name,
                phone: phone,
                pickupLocation: pickup,
                dropoffLocation: dropoff,
                date: date,
                scheduledTime: formatTime(time),
                pickupTime: '',
                dropoffTime: '',
                fare: formattedFare,
                status: 'scheduled', // New rides start as 'scheduled'
                addedAt: new Date().toISOString()
            };

            ridesData.push(newRide); // Add new ride to the data array
            saveData(); // Persist the updated data

            closeModal(); // Close the form modal
            showNotification(`✅ Ride scheduled for ${name}!`);
            updateStats(); // Update home screen statistics
            
            // Immediately refresh the relevant ride list if the new ride applies to it
            const today = getLocalDateString();
            const tomorrowDate = getTomorrowDateString();

            if (date === today && document.getElementById('todaysScreen').classList.contains('active')) {
                displayTodaysRides();
            } else if (date === tomorrowDate && document.getElementById('tomorrowsScreen').classList.contains('active')) {
                displayTomorrowsRides();
            } else if (date > tomorrowDate && document.getElementById('futureScreen').classList.contains('active')) {
                displayFutureRides(); // Refresh future rides if adding a future ride while on that screen
            }
        }

        // Helper: Converts 24-hour time string to 12-hour format (e.g., "14:30" -> "2:30 PM")
        function formatTime(time24) {
            if (!time24) return '';
            const [hours, minutes] = time24.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12; // Handles 0 for midnight as 12 AM
            return `${hour12}:${minutes} ${ampm}`;
        }

        // Export data to clipboard and optionally as a file
        function exportData() {
            console.log('Initiating data export.');
            // Filter only completed rides for the export report
            const allCompletedRides = ridesData.filter(ride => ride.status === 'completed');

            if (allCompletedRides.length === 0) {
                showNotification('ℹ️ No completed rides to export yet!'); // Use custom notification
                return;
            }

            // Sort completed rides by date and then by dropoff time for better report order
            allCompletedRides.sort((a, b) => {
                const dateTimeA = new Date(`${a.date} ${a.dropoffTime}`);
                const dateTimeB = new Date(`${b.date} ${b.dropoffTime}`);
                return dateTimeA.getTime() - dateTimeB.getTime(); // Compare timestamps
            });


            // Construct the export text in a simple table-like format
            let exportText = "KTRANSPORT360 DAILY EXPORT\n";
            exportText += `Report Generated: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}\n\n`;
            exportText += "Customer Name | Phone | Pickup Location | Dropoff Location | Scheduled Time | Pickup Time | Dropoff Time | Fare | Ride Date\n";
            exportText += "=".repeat(150) + "\n"; // A long separator line

            allCompletedRides.forEach(ride => {
                // Ensure all fields are strings to avoid issues with join
                const row = [
                    ride.name,
                    ride.phone,
                    ride.pickupLocation,
                    ride.dropoffLocation,
                    ride.scheduledTime,
                    ride.pickupTime,
                    ride.dropoffTime,
                    ride.fare,
                    new Date(ride.date).toLocaleDateString() // Format date for readability
                ].join(' | ');
                exportText += row + '\n';
            });

            let totalEarnings = 0;
            allCompletedRides.forEach(ride => {
                if (ride.fare) {
                    totalEarnings += parseFloat(ride.fare.replace('$', '')) || 0;
                }
            });

            exportText += "\n" + "=".repeat(150) + "\n";
            exportText += `SUMMARY: ${allCompletedRides.length} completed rides | Total Earnings: $${totalEarnings.toFixed(2)}`;

            // Try to copy to clipboard using modern API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(exportText).then(() => {
                    showNotification('📋 Data copied to clipboard! Paste into your spreadsheet or notes app.');
                }).catch(err => {
                    console.error('Clipboard writeText failed, attempting fallback:', err);
                    fallbackCopyText(exportText);
                });
            } else {
                // Fallback for older browsers
                fallbackCopyText(exportText);
            }

            // After a short delay, ask if the user wants to download the file
            setTimeout(() => {
                if (confirm('💾 Would you like to download this data as a file too?')) {
                    downloadData(exportText, `KTransport360_Export_${new Date().toISOString().split('T')[0]}.txt`);
                }
            }, 2000);
        }

        // Fallback method for copying text to clipboard (for older browsers)
        function fallbackCopyText(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            // Make the textarea invisible and outside the viewport
            textArea.style.position = 'fixed'; 
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select(); // Select the text
            
            try {
                document.execCommand('copy'); // Execute the copy command
                showNotification('📋 Data copied (fallback)! Paste into your spreadsheet or notes app.');
            } catch (err) {
                console.error('Fallback copy failed:', err);
                showNotification('❌ Copy failed - Please manually select and copy the data.');
            } finally {
                document.body.removeChild(textArea); // Clean up the textarea
            }
        }

        // Initiates a file download
        function downloadData(content, filename) {
            try {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none'; // Hide the anchor element
                document.body.appendChild(a);
                a.click(); // Programmatically click to trigger download
                document.body.removeChild(a); // Clean up
                URL.revokeObjectURL(url); // Free up the object URL
                showNotification('💾 File downloaded to your device!');
            } catch (error) {
                console.error('Error during file download:', error);
                showNotification('❌ Download failed.');
            }
        }

        // Displays a temporary notification message
        function showNotification(message) {
            const notification = document.getElementById('notification');
            if (!notification) {
                console.warn('Notification element not found. Cannot display notification:', message);
                return;
            }
            notification.textContent = message;
            notification.classList.add('show'); // Trigger CSS transition to show
            
            setTimeout(() => {
                notification.classList.remove('show'); // Hide after 4 seconds
            }, 4000);
        }

        // Event listener to close modal when clicking outside its content
        window.onclick = function(event) {
            const addModal = document.getElementById('addRideModal');
            const cancelModal = document.getElementById('cancelConfirmModal');
            const completedModal = document.getElementById('completedRidesModal');
            const rescheduleModal = document.getElementById('rescheduleRideModal');
            
            if (addModal && event.target === addModal) {
                closeModal();
            }
            if (cancelModal && event.target === cancelModal) {
                closeCancelModal();
            }
            if (completedModal && event.target === completedModal) {
                closeCompletedRidesModal();
            }
            if (rescheduleModal && event.target === rescheduleModal) {
                closeRescheduleModal();
            }
        };

        // Auto-save data to localStorage every 30 seconds
        setInterval(() => {
            saveData();
            saveCommonLocationsData(); // Also auto-save common locations
            console.log('Auto-saved data to localStorage.');
        }, 30000);

        // Update status bar with current time every minute
        function updateStatusBar() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const statusBar = document.getElementById('statusBar');
            if (statusBar) {
                statusBar.textContent = `📱 App Ready - Last updated: ${timeString}`;
            }
        }
        setInterval(updateStatusBar, 60000); // Update every minute

        // Global error handler for unhandled JavaScript errors
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Global JS Error Caught:');
            console.error('Message:', msg);
            console.error('URL:', url);
            console.error('Line:', lineNo, 'Column:', columnNo);
            console.error('Error Object:', error);
            // Optionally, show a more prominent error message to the user
            showNotification('Fatal Error! Check console for details. 🚨');
            return false; // Suppress default browser error reporting
        };

        // Function to clear all completed rides from local storage
        function clearAllCompletedRides() {
            const initialCompletedCount = ridesData.filter(ride => ride.status === 'completed').length;

            if (initialCompletedCount === 0) {
                showNotification('ℹ️ No completed rides to clear!');
                return;
            }

            // Ask for confirmation before clearing
            const confirmClear = confirm('Are you sure you want to clear ALL completed rides? This action cannot be undone. \n\nWe recommend exporting your data to a spreadsheet first if you want to keep a record!');

            if (confirmClear) {
                // Filter out all completed rides
                ridesData = ridesData.filter(ride => ride.status !== 'completed');
                saveData(); // Save the updated ridesData (without completed rides)

                showNotification(`🧹 Cleared ${initialCompletedCount} completed rides! Earnings reset.`);
                updateStats(); // Refresh stats on home screen
                displayTodaysRides(); // Refresh ride lists
                displayTomorrowsRides();
                displayFutureRides();
            } else {
                showNotification('Clear operation cancelled.');
            }
        }
    </script>
</body>
</html>
```

## **📅 PICKUP DATE DISPLAY ADDED! **

**What's New:**
- **Calendar emoji** `📅` added above the clock emoji `⏰` in all ride cards
- **Formatted pickup date** displays as "June 12, 2025" instead of "2025-06-12"
- **Applied to ALL sections**: Today's, Tomorrow's, and Future rides
- **Completed rides modal** also shows the formatted date

**New Route Info Format:**
```
📅 June 12, 2025
⏰ 2:30 PM  
📍 From: Jacksonville Airport
🎯 To: Downtown Jacksonville
```

**Where You'll See It:**
- **Today's Rides**: Shows today's date for clarity
- **Tomorrow's Rides**: Shows tomorrow's actual date
- **Future Rides**: Shows the specific future date
- **Completed Rides Details**: Shows the date when the ride was completed

**Benefits:**
- **Crystal clear scheduling** - no confusion about which day
- **Easy scanning** - date stands out with calendar emoji
- **Consistent formatting** - same beautiful date format everywhere
- **Better planning** - especially helpful for future rides spanning multiple dates

Now every ride card clearly shows exactly when the pickup is scheduled, making it impossible to miss the date! The calendar emoji makes it instantly recognizable at a glance.
